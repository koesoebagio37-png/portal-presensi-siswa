<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siswa App - Comfort & Glow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'cyber': { 900: '#02120a', 800: '#051f15', 700: '#064e3b', 500: '#10b981', 400: '#34d399' },
                        'emerald': { 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-item.active { color: #059669; } 
        .nav-item.active svg { fill: currentColor; opacity: 0.1; }
        #reader { width: 100%; border-radius: 1rem; overflow: hidden; }
        #reader video { object-fit: cover; border-radius: 1rem; }
        .page { display: none; padding-bottom: 80px; }
        .page.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-cyber-900 dark:text-white min-h-screen transition-colors duration-300">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white dark:bg-cyber-900 flex flex-col items-center justify-center p-6">
        <div class="w-24 h-24 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center shadow-sm mb-6">
            <div class="w-16 h-16 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg text-white">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h4.01M16 3h5v5h-5V3zm0 13h5v5h-5v-5zm-9 4h10v2h-10v-2zm-6-6h10v2h-10v-2z"></path></svg>
            </div>
        </div>
        <h1 class="text-2xl font-bold mb-1 text-gray-800 dark:text-emerald-50">Presensi Siswa</h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-8">Masukkan NIS untuk memulai</p>
        
        <input type="text" inputmode="numeric" id="login-nis" class="w-full max-w-xs p-4 bg-gray-50 border border-gray-200 rounded-xl text-center text-lg font-bold tracking-widest focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none dark:bg-cyber-800 dark:border-emerald-800 dark:text-white transition-all" placeholder="Nomor Induk Siswa">
        
        <button onclick="window.doLogin()" class="mt-6 w-full max-w-xs bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-2">
            <span>Masuk Aplikasi</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
        </button>
        <p id="login-error" class="mt-4 text-red-500 text-sm hidden bg-red-50 dark:bg-red-900/20 px-3 py-1 rounded-lg border border-red-100 dark:border-red-800">NIS tidak ditemukan</p>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="px-6 pt-8 pb-4 bg-white dark:bg-cyber-800 shadow-sm sticky top-0 z-30 border-b border-gray-100 dark:border-emerald-900">
            <div class="flex justify-between items-center">
                <div>
                    <p id="header-date" class="text-xs text-gray-500 dark:text-emerald-400/80">Halo, selamat pagi</p>
                    <h2 id="user-name" class="text-xl font-bold text-gray-900 dark:text-white">Nama Siswa</h2>
                    <span id="user-class" class="text-xs bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded dark:bg-emerald-900/30 dark:text-emerald-300 border border-emerald-100 dark:border-emerald-800">Kelas -</span>
                </div>
                <img src="" id="user-avatar" class="w-10 h-10 rounded-full bg-gray-200 object-cover ring-2 ring-emerald-100 dark:ring-emerald-800">
            </div>
        </header>

        <!-- PAGE: HOME -->
        <div id="page-home" class="page active px-6 py-4 space-y-6">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-6 text-white shadow-lg shadow-emerald-500/20 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-white/80 text-sm mb-1">Status Kehadiran</p>
                    <h3 id="today-status" class="text-2xl font-bold">Siap Presensi</h3>
                    <p id="today-time" class="text-sm opacity-90 mt-1">Silakan scan QR Mapel Guru</p>
                </div>
                <div class="absolute right-[-20px] bottom-[-20px] opacity-20">
                    <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                </div>
            </div>

            <!-- MENU GRID -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Tombol Scan -->
                <button id="btn-scan-main" onclick="window.openScanner()" class="bg-white dark:bg-cyber-800 p-6 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform border border-gray-100 dark:border-emerald-900 hover:border-emerald-200 dark:hover:border-emerald-700 group">
                    <div class="w-12 h-12 bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h4.01M16 3h5v5h-5V3zm0 13h5v5h-5v-5zm-9 4h10v2h-10v-2zm-6-6h10v2h-10v-2z"></path></svg>
                    </div>
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-200">Scan Masuk</span>
                </button>

                <!-- Tombol Manual Token -->
                <button id="btn-token-manual" onclick="window.openManualInput()" class="bg-white dark:bg-cyber-800 p-6 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform border border-gray-100 dark:border-emerald-900 hover:border-purple-200 dark:hover:border-purple-700 group">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                    </div>
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-200">Input Token</span>
                </button>

                <!-- Tombol Izin -->
                <button onclick="window.switchPage('permission')" class="col-span-2 bg-white dark:bg-cyber-800 p-5 rounded-2xl shadow-sm flex items-center justify-between px-6 gap-3 active:scale-95 transition-transform border border-gray-100 dark:border-emerald-900 hover:border-blue-200 dark:hover:border-blue-700 group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="block font-bold text-sm text-gray-700 dark:text-gray-200">Izin / Sakit</span>
                            <span class="text-xs text-gray-400">Kirim surat keterangan</span>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

        </div>

        <!-- PAGE: PERMISSION -->
        <div id="page-permission" class="page px-6 py-4">
            <!-- HEADER PERMISSION -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="window.switchPage('home')" class="p-2 bg-white dark:bg-cyber-800 rounded-full shadow-sm hover:bg-gray-50 dark:hover:bg-cyber-700 border border-gray-100 dark:border-emerald-900">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white leading-tight">Formulir Izin</h2>
                        <p class="text-xs text-gray-500">Isi data dengan benar</p>
                    </div>
                </div>
                <!-- Tombol Kirim Pindah ke Sini -->
                <button onclick="window.submitPermission()" id="btn-perm-top" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2.5 px-5 rounded-xl shadow-lg shadow-emerald-500/20 transition-all transform active:scale-95 flex items-center gap-2">
                    <span>Kirim</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>

             <div class="space-y-5 bg-white dark:bg-cyber-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-emerald-900">
                <!-- NEW FIELD: MAPEL (MANDATORY FOR SYNC) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mata Pelajaran</label>
                    <input type="text" id="perm-mapel" class="w-full p-4 bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="Contoh: Matematika, Bahasa Inggris...">
                    <p class="text-[10px] text-orange-500 mt-1">*Wajib diisi agar masuk ke absen Guru Mapel</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Keterangan</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="perm-type" value="s" class="peer sr-only" checked>
                            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 text-center transition-all">
                                <span class="font-bold text-blue-600 dark:text-blue-400">Sakit</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="perm-type" value="i" class="peer sr-only">
                            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 dark:peer-checked:bg-yellow-900/20 text-center transition-all">
                                <span class="font-bold text-yellow-600 dark:text-yellow-400">Izin</span>
                            </div>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alasan Lengkap</label>
                    <textarea id="perm-reason" rows="4" class="w-full p-4 bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500 dark:text-white" placeholder="Contoh: Demam tinggi sejak semalam..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bukti Foto (Surat)</label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer bg-gray-50 dark:bg-cyber-900 hover:bg-gray-100 dark:hover:bg-cyber-800 transition-colors relative overflow-hidden">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 z-10">
                            <svg class="w-8 h-8 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <p class="text-xs text-gray-500">Klik untuk ambil foto</p>
                        </div>
                        <input type="file" id="perm-file" class="hidden" accept="image/*" capture="environment">
                        <img id="perm-preview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden">
                    </label>
                </div>
            </div>
        </div>

        <!-- PAGE: PROFILE -->
        <div id="page-profile" class="page px-6 py-4 text-center">
            <img src="" id="profile-avatar-lg" class="w-24 h-24 rounded-full bg-gray-200 mx-auto mb-4 object-cover ring-4 ring-white dark:ring-cyber-800 shadow-lg">
            <h2 id="profile-name" class="text-xl font-bold text-gray-900 dark:text-white">Nama Siswa</h2>
            <p id="profile-nis" class="text-gray-500 dark:text-emerald-400 mb-8 font-mono">NIS: -</p>
            <button onclick="window.doLogout()" class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-cyber-800 dark:hover:bg-cyber-700 text-gray-700 dark:text-gray-300 font-bold py-3 rounded-xl transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Keluar Akun
            </button>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full bg-white dark:bg-cyber-800 border-t border-gray-200 dark:border-emerald-900 flex justify-around py-3 pb-5 z-40">
            <button onclick="window.switchPage('home')" class="nav-item active flex flex-col items-center gap-1 w-full group">
                <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-[10px] font-bold">Beranda</span>
            </button>
            <button onclick="window.switchPage('profile')" class="nav-item text-gray-400 flex flex-col items-center gap-1 w-full group">
                <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-[10px] font-bold">Profil</span>
            </button>
        </div>
    </div>

    <!-- SCANNER MODAL -->
    <div id="scanner-modal" class="fixed inset-0 z-[60] bg-black hidden flex-col">
        <div class="p-4 flex justify-between items-center text-white absolute top-0 w-full z-10 bg-gradient-to-b from-black/50 to-transparent">
            <h3 class="font-bold">Scan QR Guru</h3>
            <button onclick="window.closeScanner()" class="p-2 bg-white/20 rounded-full backdrop-blur hover:bg-white/30 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div id="reader" class="w-full h-full bg-black relative">
            <!-- Scan region marker -->
            <div class="absolute inset-0 border-2 border-emerald-500 opacity-50 pointer-events-none m-12 rounded-xl"></div>
        </div>
        <div class="absolute bottom-10 w-full text-center text-white/80 px-6">
            <p class="text-sm mb-4">Arahkan kamera ke QR Code Mapel</p>
            <p id="scan-status" class="text-xs font-mono bg-black/50 py-1 px-3 rounded-full inline-block backdrop-blur">Kamera Aktif</p>
        </div>
    </div>

    <!-- MANUAL TOKEN MODAL (UPDATED FOR MAPEL FIX) -->
    <div id="token-modal" class="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-6">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl relative animate-fade-in-up">
            <button onclick="closeManualInput()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">✕</button>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl text-indigo-600">⌨️</div>
                <h3 class="font-bold text-gray-800 dark:text-white">Input Token</h3>
                <p class="text-xs text-gray-500">Masukkan Mapel & Token Guru</p>
            </div>
            
            <div class="space-y-3">
                <!-- Input Mapel Manual (AUTO TITLE CASE) -->
                <input type="text" id="manual-mapel-input" class="w-full p-3 text-center text-sm font-bold bg-gray-100 dark:bg-gray-800 rounded-xl border border-transparent focus:border-indigo-500 outline-none transition-all placeholder-gray-400" placeholder="Nama Mapel (Otomatis)">
                
                <!-- Input Token -->
                <input type="text" id="manual-token-input" class="w-full p-4 text-center text-2xl font-mono font-bold tracking-[0.5em] bg-gray-100 dark:bg-gray-800 rounded-xl border border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-gray-900 outline-none transition-all uppercase" maxlength="4" placeholder="----">
            </div>

            <button onclick="submitManualToken()" class="w-full mt-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg">Verifikasi</button>
            <p class="text-[10px] text-gray-400 text-center mt-3">*Nama Mapel akan otomatis disesuaikan.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwIwimlyrE4qQqYa2gA8Pfygd59USsveQ",
            authDomain: "aplikasi-ulangan-01.firebaseapp.com",
            projectId: "aplikasi-ulangan-01",
            storageBucket: "aplikasi-ulangan-01.firebasestorage.app",
            messagingSenderId: "409085062439",
            appId: "1:409085062439:web:280589d1a3e12e7b980d02",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let html5QrCode;
        let currentUserData = null;

        // --- TITLE CASE HELPER ---
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await signInAnonymously(auth);

            // Cek Login Session
            const savedNis = localStorage.getItem('student_nis');
            if(savedNis) attemptLogin(savedNis);

            // Permission File Listener
            document.getElementById('perm-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('perm-preview').src = e.target.result;
                        document.getElementById('perm-preview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Set Date Indonesia
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const todayIndo = new Date().toLocaleDateString('id-ID', options).toUpperCase();
            
            const headerDateEl = document.getElementById('header-date');
            if(headerDateEl) {
                headerDateEl.innerText = todayIndo;
            }
        });

        // TIME FIX UTILITY (WIB FORCE)
        function getIndoDateString() {
            const now = new Date();
            const utcMs = now.getTime();
            const wibOffset = 7 * 60 * 60 * 1000;
            const wibDate = new Date(utcMs + wibOffset); 
            return wibDate.toISOString().split('T')[0];
        }

        // --- AUTH LOGIC ---
        window.doLogin = () => {
            const nis = document.getElementById('login-nis').value.trim();
            if(nis) attemptLogin(nis);
        };

        async function attemptLogin(rawNis) {
            const btn = document.querySelector('#login-screen button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>Memeriksa...</span>'; 
            btn.disabled = true;
            document.getElementById('login-error').classList.add('hidden');
            
            try {
                let docSnap = await getDoc(doc(db, 'siswa', rawNis));
                
                if (!docSnap.exists()) {
                    const clean = rawNis.replace(/[^0-9]/g, '');
                    if (clean.length === 9) {
                        const formatted = `${clean.substring(0,4)}.${clean.substring(4,6)}.${clean.substring(6)}`;
                        docSnap = await getDoc(doc(db, 'siswa', formatted));
                        if(docSnap.exists()) rawNis = formatted;
                    }
                }

                if (docSnap.exists()) {
                    currentUserData = { id: docSnap.id, ...docSnap.data() };
                    localStorage.setItem('student_nis', docSnap.id);
                    initAppUI();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                    localStorage.removeItem('student_nis');
                }
            } catch (e) {
                alert("Error login: " + e.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }

        window.doLogout = () => {
            if(confirm('Keluar dari akun?')) {
                localStorage.removeItem('student_nis');
                location.reload();
            }
        };

        function initAppUI() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUserData.nama;
            document.getElementById('user-class').textContent = currentUserData.kelas;
            document.getElementById('user-avatar').src = currentUserData.foto || `https://ui-avatars.com/api/?name=${currentUserData.nama}&background=10b981&color=fff`;
            document.getElementById('profile-name').textContent = currentUserData.nama;
            document.getElementById('profile-nis').textContent = "NIS: " + currentUserData.id;
            document.getElementById('profile-avatar-lg').src = document.getElementById('user-avatar').src;
            
            resetStatusUI();
        }

        function updateStatusUI(status, time, bgClass, mapelName) {
            document.getElementById('today-status').textContent = status;
            document.getElementById('today-time').textContent = time !== '-' ? `Tercatat: ${time} (${mapelName || 'Mapel'})` : 'Menunggu Konfirmasi Guru';
            const card = document.querySelector('#today-status').parentElement.parentElement;
            card.className = `rounded-2xl p-6 text-white shadow-lg relative overflow-hidden ${bgClass}`;
        }

        function resetStatusUI() {
            document.getElementById('today-status').textContent = "Siap Presensi";
            document.getElementById('today-time').textContent = "Silakan Scan QR Mapel Guru";
            const card = document.querySelector('#today-status').parentElement.parentElement;
            card.className = "bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-6 text-white shadow-lg shadow-emerald-500/20 relative overflow-hidden";
            
            document.getElementById('btn-scan-main').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-token-manual').classList.remove('opacity-50', 'pointer-events-none');
        }

        // --- SCANNER LOGIC ---
        window.openScanner = () => {
            document.getElementById('scanner-modal').classList.remove('hidden');
            document.getElementById('scanner-modal').classList.add('flex');
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                console.error(err);
                alert("Gagal akses kamera. Pastikan izin diberikan atau gunakan Token Manual.");
                window.closeScanner();
            });
        };

        window.closeScanner = () => {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('scanner-modal').classList.add('hidden');
                    document.getElementById('scanner-modal').classList.remove('flex');
                }).catch(err => console.log(err));
            } else {
                document.getElementById('scanner-modal').classList.add('hidden');
                document.getElementById('scanner-modal').classList.remove('flex');
            }
        };

        async function onScanSuccess(decodedText) {
            html5QrCode.pause();
            document.getElementById('scan-status').textContent = "Memproses...";
            try {
                const data = JSON.parse(decodedText);
                
                // VALIDASI GANDA (KELAS & MAPEL)
                // FIX: Trim kelas untuk menghindari masalah spasi
                if (data.c.trim() !== currentUserData.kelas.trim()) throw new Error(`QR Kelas Salah! Ini QR untuk kelas ${data.c}`);
                if (!data.m) throw new Error("QR Tidak Valid: Data Mapel tidak ditemukan. Pastikan Guru menggunakan aplikasi terbaru.");
                if (!data.d) throw new Error("QR Tidak Valid: Tanggal tidak ditemukan.");

                // Mapel from QR is assumed to be correct (Title Case or whatever teacher uses)
                await processAttendance(data.t, 'qr', data.m, data.d);
            } catch (e) {
                alert("Gagal: " + e.message);
                setTimeout(() => html5QrCode.resume(), 2000);
            }
        }

        function onScanFailure(error) {}

        // --- MANUAL TOKEN LOGIC (FIXED) ---
        window.openManualInput = () => {
            document.getElementById('token-modal').classList.remove('hidden');
            document.getElementById('token-modal').classList.add('flex');
            document.getElementById('manual-token-input').value = '';
            document.getElementById('manual-mapel-input').value = '';
            document.getElementById('manual-mapel-input').focus();
        };

        window.closeManualInput = () => {
            document.getElementById('token-modal').classList.add('hidden');
            document.getElementById('token-modal').classList.remove('flex');
        };

        window.submitManualToken = async () => {
            const token = document.getElementById('manual-token-input').value.toUpperCase();
            // FIX: Enforce Title Case automatically
            let mapel = document.getElementById('manual-mapel-input').value.trim();
            mapel = toTitleCase(mapel);

            if (!mapel) return alert("Masukkan Nama Mapel!");
            if (token.length < 4) return alert("Token minimal 4 karakter");
            
            window.closeManualInput();
            // Gunakan fungsi tanggal yang sudah diperbaiki (WIB Force)
            await processAttendance(token, 'manual', mapel, getIndoDateString());
        };

        // CORE ATTENDANCE PROCESSOR (UPDATED FOR MAPEL)
        async function processAttendance(token, method, mapelName, dateStr) {
            // KONSTRUKSI ID DOKUMEN: Kelas_Mapel_Tanggal
            // FIX: Trim Mapel dan Kelas untuk keamanan
            const safeMapel = mapelName.trim();
            const safeKelas = currentUserData.kelas.trim();
            const docId = `${safeKelas}_${safeMapel}_${dateStr}`;
            
            // LOG DEBUG (Bisa dilihat di Console Laptop dengan F12)
            console.log("Mencoba Absen ke ID:", docId);

            const docRef = doc(db, 'presensi', docId);
            const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            try {
                const updateData = {};
                updateData[currentUserData.id] = {
                    status: 'h', 
                    time: timeStr,
                    method: method,
                    token: token,
                    timestamp: serverTimestamp()
                };

                // Merge: true agar tidak menimpa data siswa lain
                await setDoc(docRef, updateData, { merge: true });
                
                alert(`✅ Presensi BERHASIL!\nMapel: ${safeMapel}\nWaktu: ${timeStr}`);
                updateStatusUI('Hadir', timeStr, 'bg-gradient-to-r from-emerald-600 to-teal-600', safeMapel);
                
                if(method === 'qr') window.closeScanner();
                
            } catch (e) {
                alert("Gagal memproses presensi ke server: " + e.message);
                if(method === 'qr') html5QrCode.resume();
            }
        }

        // --- PERMISSION LOGIC (REVISED FOR SYNC) ---
        window.submitPermission = async () => {
            const type = document.querySelector('input[name="perm-type"]:checked').value;
            const reason = document.getElementById('perm-reason').value.trim();
            // BARU: Ambil Mapel dari input
            let mapel = document.getElementById('perm-mapel').value.trim();
            const fileInput = document.getElementById('perm-file');
            
            if(!mapel) { alert("Harap isi Nama Mata Pelajaran!"); return; }
            if(!reason) { alert("Isi alasan!"); return; }
            
            mapel = toTitleCase(mapel); // Pastikan format mapel seragam

            const btn = document.getElementById('btn-perm-top');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerText = "Mengirim...";

            try {
                let base64Image = "";
                if(fileInput.files.length > 0) base64Image = await compressImage(fileInput.files[0]);

                const today = getIndoDateString();
                const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                // 1. UPLOAD BUKTI (Supaya Guru bisa lihat fotonya)
                const proofId = `${currentUserData.id}_${today}`;
                const proofRef = doc(db, 'bukti_izin', proofId);
                await setDoc(proofRef, {
                    nama: currentUserData.nama,
                    nis: currentUserData.id,
                    kelas: currentUserData.kelas,
                    tanggal: today,
                    tipe: type,
                    alasan: reason,
                    foto: base64Image
                });

                // 2. UPDATE ABSEN GURU (Supaya status berubah jadi S/I di tabel Guru)
                const safeKelas = currentUserData.kelas.trim();
                const docId = `${safeKelas}_${mapel}_${today}`;
                const presensiRef = doc(db, 'presensi', docId);

                const updateData = {};
                updateData[currentUserData.id] = {
                    status: type,       // 's' atau 'i'
                    time: timeStr,      // Jam kirim
                    method: 'permit',   // Metode izin
                    buktiAda: true,     // Trigger tombol "Lihat Bukti" di Guru
                    timestamp: serverTimestamp()
                };

                // Kita gunakan setDoc dengan merge untuk memastikan dokumen dibuat jika belum ada
                // Penting: Sertakan field mapel di root dokumen agar Guru bisa load report nanti
                await setDoc(presensiRef, { mapel: mapel }, { merge: true });
                await setDoc(presensiRef, updateData, { merge: true });

                const statusText = type === 's' ? 'Sakit' : 'Izin';
                alert(`Izin ${statusText} Terkirim untuk mapel ${mapel}.`);
                
                // Update UI Home
                updateStatusUI(statusText, timeStr, 'bg-gradient-to-r from-blue-500 to-indigo-600', mapel);
                window.switchPage('home');

            } catch(e) { 
                alert("Gagal: " + e.message); 
            } finally { 
                btn.disabled = false; btn.innerHTML = originalText; 
            }
        };

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 500; 
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        window.switchPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navBtns = document.querySelectorAll('.nav-item');
            if(pageId === 'home') navBtns[0].classList.add('active');
            else if(pageId === 'profile') navBtns[1].classList.add('active');
        };
    </script>
</body>
</html>
